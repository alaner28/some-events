{"version":3,"file":"useUserStore.js","sources":["store/useUserStore.ts"],"sourcesContent":["import { defineStore } from 'pinia'\ninterface User{\r\n\tuid:string\r\n\tusername:string\r\n\tnickname:string\r\n\temail:string\r\n\tavatar:string//头像\r\n\tphone?:string\r\n\tgender:'男'|'女'|'unknown'\r\n\taddress?:string\r\n\tcreatedAt:Date\r\n\tlastLogin?:Date\r\n}\r\nexport const useUserStore=defineStore('user',{\r\n\tstate:()=>({\r\n\t\tcurrentUser:null as User | null,//创建一个对象实例\r\n\t\tdefaultAvatars:'/static/OIP-c.jpg',\r\n\t\t//用户状态元数据\r\n\t\tmeta:{\r\n\t\t\tisLoggedin:false,\r\n\t\t\ttokenExpiresAt:0//token过期时间戳\r\n\t\t}\r\n\t}),\r\n\t\r\n\tgetters:{\r\n\t\tdisplayName(state):string{\r\n\t\t\treturn state.currentUser?.username||'未登录用户'\r\n\t\t},\r\n\t\tformattedJoinDate(state):string{\r\n\t\t\tif(!state.currentUser)return ''\r\n\t\t\treturn new Date(state.currentUser.createdAt).toLocaleDateString('zh-CN')\r\n\t\t},\r\n\t\t\r\n\t\tgetDefaltAvatar(state):string{\r\n\t\t\treturn state.defaultAvatars\r\n\t\t}\t\r\n\t},\r\n\t\r\n\tactions:{\r\n\t\tasync initializeUser(){\r\n\t\t\ttry{\r\n\t\t\t\tconst token=uni.getStorageSync('token')//读取本地保存的登录凭证\r\n\t\t\t\tif(token){\r\n\t\t\t\t\t//获得新数据\r\n\t\t\t\t\tconst user=await this.fetchUserProfile()\r\n\t\t\t\t\t//替换数据\r\n\t\t\t\t\tthis.setUser(user)//更新用户状态\r\n\t\t\t\t}\r\n\t\t\t}catch(error){\r\n\t\t\t\tconsole.error('用户初始化失败:',error)\r\n\t\t\t}\r\n\t\t},\r\n\t\t\r\n\t\t//获取用户资料\r\n\t\tasync fetchUserProfile():Promise<User>{\r\n\t\t\tconst response:any =await uni.request({\r\n\t\t\t\turl:'',\r\n\t\t\t\tmethod:'GET'\r\n\t\t\t})\r\n\t\t\tif(response.statusCode!==200){\r\n\t\t\t\tthrow new Error('获取用户信息失败')\r\n\t\t\t}\r\n\t\t\treturn {\r\n\t\t\t\t...response.data,\r\n\t\t\t\tcreatedAt: new Date(response.data.createdAt),\r\n\t\t\t\tlastLogin: new Date(response.data.lastLogin)\r\n\t\t\t}\r\n\t\t},\r\n\t\t//替换新的 userprofile\r\n\t\tsetUser(userData:User){\r\n\t\t\tthis.currentUser={\r\n\t\t\t\t...userData,\r\n\t\t\t\tavatar:userData.avatar||this.getDefaltAvatar\r\n\t\t\t}\r\n\t\t\tthis.meta.isLoggedIn=true\r\n\t\t\t//同步到本地存储\r\n\t\t\tuni.setStorageSync('userData',JSON.stringify(userData))\r\n\t\t},\r\n\t\t\r\n\t\t\r\n\t\tupdateUserProfile(partialData: Partial<User>) {\r\n\t\t\tif (!this.currentUser) return\r\n\t\t  \r\n\t\t\tthis.currentUser = {\r\n\t\t\t\t...this.currentUser,\r\n\t\t\t\t...partialData\r\n\t\t\t}\r\n\t\t\tuni.setStorageSync('userData', JSON.stringify(this.currentUser))\r\n\t\t},\r\n\t\tclearUser() {\r\n\t\t\tthis.currentUser = null\r\n\t\t\tthis.meta.isLoggedIn = false\r\n\t\t\tuni.removeStorageSync('token')\r\n\t\t\tuni.removeStorageSync('userData')\r\n\t\t}\r\n\t}\r\n}\r\n)"],"names":["defineStore","uni"],"mappings":";;AAaO,MAAM,eAAaA,cAAA;AAAA,EAAY;AAAA,EAAO;AAAA,IAC5C,OAAM,OAAK;AAAA,MACV,aAAY;AAAA;AAAA,MACZ,gBAAe;AAAA;AAAA,MAEf,MAAK;AAAA,QACJ,YAAW;AAAA,QACX,gBAAe;AAAA;AAAA,MAChB;AAAA,IAAA;AAAA,IAGD,SAAQ;AAAA,MACP,YAAY,OAAa;;AACjB,iBAAA,WAAM,gBAAN,mBAAmB,aAAU;AAAA,MACrC;AAAA,MACA,kBAAkB,OAAa;AAC9B,YAAG,CAAC,MAAM;AAAmB,iBAAA;AAC7B,eAAO,IAAI,KAAK,MAAM,YAAY,SAAS,EAAE,mBAAmB,OAAO;AAAA,MACxE;AAAA,MAEA,gBAAgB,OAAa;AAC5B,eAAO,MAAM;AAAA,MACd;AAAA,IACD;AAAA,IAEA,SAAQ;AAAA,MACP,MAAM,iBAAgB;AAClB,YAAA;AACI,gBAAA,QAAMC,cAAAA,MAAI,eAAe,OAAO;AACtC,cAAG,OAAM;AAEF,kBAAA,OAAK,MAAM,KAAK;AAEtB,iBAAK,QAAQ,IAAI;AAAA,UAClB;AAAA,iBACM,OAAM;AACZA,wBAAA,MAAA,MAAA,SAAA,+BAAc,YAAW,KAAK;AAAA,QAC/B;AAAA,MACD;AAAA;AAAA,MAGA,MAAM,mBAAgC;AAC/B,cAAA,WAAc,MAAMA,cAAA,MAAI,QAAQ;AAAA,UACrC,KAAI;AAAA,UACJ,QAAO;AAAA,QAAA,CACP;AACE,YAAA,SAAS,eAAa,KAAI;AACtB,gBAAA,IAAI,MAAM,UAAU;AAAA,QAC3B;AACO,eAAA;AAAA,UACN,GAAG,SAAS;AAAA,UACZ,WAAW,IAAI,KAAK,SAAS,KAAK,SAAS;AAAA,UAC3C,WAAW,IAAI,KAAK,SAAS,KAAK,SAAS;AAAA,QAAA;AAAA,MAE7C;AAAA;AAAA,MAEA,QAAQ,UAAc;AACrB,aAAK,cAAY;AAAA,UAChB,GAAG;AAAA,UACH,QAAO,SAAS,UAAQ,KAAK;AAAA,QAAA;AAE9B,aAAK,KAAK,aAAW;AAErBA,sBAAA,MAAI,eAAe,YAAW,KAAK,UAAU,QAAQ,CAAC;AAAA,MACvD;AAAA,MAGA,kBAAkB,aAA4B;AAC7C,YAAI,CAAC,KAAK;AAAa;AAEvB,aAAK,cAAc;AAAA,UAClB,GAAG,KAAK;AAAA,UACR,GAAG;AAAA,QAAA;AAEJA,sBAAA,MAAI,eAAe,YAAY,KAAK,UAAU,KAAK,WAAW,CAAC;AAAA,MAChE;AAAA,MACA,YAAY;AACX,aAAK,cAAc;AACnB,aAAK,KAAK,aAAa;AACvBA,4BAAI,kBAAkB,OAAO;AAC7BA,4BAAI,kBAAkB,UAAU;AAAA,MACjC;AAAA,IACD;AAAA,EACD;AACA;;"}